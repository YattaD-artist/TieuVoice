<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ti√™u Meow Live</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <meta name="theme-color" content="#ff9800">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body {
            margin: 0;
            background: #0f0f0f;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .card {
            background: #1a1a1a;
            padding: 2.5rem;
            border-radius: 40px;
            width: 320px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        h1 {
            color: #ff9800;
            font-size: 1.1rem;
            margin-bottom: 1.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .controls-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .tiger-btn {
            width: 100px;
            height: 100px;
            background: #252525;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            border: 4px solid #333;
            user-select: none;
        }
        .circle-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #ff9800;
            color: #ff9800;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .live-active {
            background: #ff9800 !important;
            color: #000 !important;
            box-shadow: 0 0 20px rgba(255,152,0,0.6);
        }
        .playing {
            animation: pulse 1s infinite;
            border-color: #ff9800;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,152,0,0.4); }
            70% { box-shadow: 0 0 0 20px rgba(255,152,0,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,152,0,0); }
        }
        .output-section {
            margin-top: 15px;
            text-align: left;
        }
        .output-label {
            font-size: 10px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        #outputSelector {
            width: 100%;
            background: #252525;
            color: #ff9800;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        #status {
            margin-top: 15px;
            font-size: 0.75rem;
            color: #ff9800;
        }
    </style>
</head>

<body>

<div class="card">
    <h1>Ti√™u Meow Live</h1>

    <div class="controls-row">
        <div class="circle-btn" id="liveBtn">LIVE</div>
        <div class="tiger-btn" id="tigerMascot">üêØ</div>
    </div>

    <div class="output-section">
        <div class="output-label">ƒê·∫ßu ra √¢m thanh</div>
        <select id="outputSelector"></select>
    </div>

    <div id="status">S·∫µn s√†ng</div>
</div>

<script>
/* ===== C·∫§U H√åNH L·ªåC √ÇM ===== */
const CONFIG = {
    micGain: 2.4,        // gi·∫£m gain ƒë·ªÉ tr√°nh h√∫t xa
    gate: -28,           // gate m·∫°nh h∆°n
    highpass: 180,       // c·∫Øt √π / ti·∫øng xa
    compThreshold: -24,
    compRatio: 4,
    pitch: 8,
    vibFreq: 4,
    vibDepth: 0.7,
    reverbWet: 0.1
};

let isLive = false;
const mic = new Tone.UserMedia();
const micGain = new Tone.Gain(CONFIG.micGain);
let liveNodes = [];

/* ===== QU√âT OUTPUT ===== */
async function updateOutputDevices() {
    await navigator.mediaDevices.getUserMedia({ audio: true });
    const devices = await navigator.mediaDevices.enumerateDevices();
    const selector = document.getElementById("outputSelector");
    selector.innerHTML = "";
    devices.filter(d => d.kind === "audiooutput").forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.deviceId;
        opt.text = d.label || "Audio Output";
        selector.appendChild(opt);
    });
}
updateOutputDevices();

/* ===== CHAIN L·ªåC √ÇM T·ªêI ∆ØU ===== */
function createChain(destination) {
    const highpass = new Tone.Filter(CONFIG.highpass, "highpass");
    const gate = new Tone.Gate(CONFIG.gate);
    const compressor = new Tone.Compressor({
        threshold: CONFIG.compThreshold,
        ratio: CONFIG.compRatio,
        attack: 0.01,
        release: 0.25
    });

    const pitch = new Tone.PitchShift(CONFIG.pitch);
    const vibrato = new Tone.Vibrato(CONFIG.vibFreq, CONFIG.vibDepth);
    const chorus = new Tone.Chorus(4, 2.5, 0.4).start();
    const lowpass = new Tone.Filter(2200, "lowpass");
    const reverb = new Tone.Reverb({ decay: 1.3, wet: CONFIG.reverbWet });

    highpass.chain(
        gate,
        compressor,
        pitch,
        vibrato,
        chorus,
        lowpass,
        reverb,
        destination
    );

    return [highpass, gate, compressor, pitch, vibrato, chorus, lowpass, reverb];
}

/* ===== LIVE ===== */
document.getElementById("liveBtn").onclick = async function () {
    if (!isLive) {
        await Tone.start();

        const selector = document.getElementById("outputSelector");
        if (Tone.getContext().rawContext.setSinkId && selector.value) {
            await Tone.getContext().rawContext.setSinkId(selector.value);
        }

        await mic.open();
        isLive = true;

        this.classList.add("live-active");
        document.getElementById("tigerMascot").classList.add("playing");
        document.getElementById("status").innerText = "ƒêANG LIVE ‚Äì ƒê√É L·ªåC √ÇM";

        liveNodes = createChain(Tone.Destination);
        mic.connect(micGain);
        micGain.connect(liveNodes[0]);

    } else {
        isLive = false;
        this.classList.remove("live-active");
        document.getElementById("tigerMascot").classList.remove("playing");
        document.getElementById("status").innerText = "ƒê√£ t·∫Øt Live";

        mic.close();
        micGain.disconnect();
        liveNodes.forEach(n => n.dispose());
        liveNodes = [];
    }
};

/* ===== PWA ===== */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
}
</script>

</body>
</html>
