<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ti√™u Meow Live</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <meta name="theme-color" content="#ff9800">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body {
            margin: 0;
            background: #0f0f0f;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .card {
            background: #1a1a1a;
            padding: 2.5rem;
            border-radius: 40px;
            width: 320px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        h1 {
            color: #ff9800;
            font-size: 1.1rem;
            margin-bottom: 1.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .controls-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .tiger-btn {
            width: 100px;
            height: 100px;
            background: #252525;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            border: 4px solid #333;
            user-select: none;
        }

        .circle-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #ff9800;
            color: #ff9800;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
        }

        .live-active {
            background: #ff9800 !important;
            color: #000 !important;
            box-shadow: 0 0 20px rgba(255,152,0,0.6);
        }

        .playing {
            animation: pulse 1s infinite;
            border-color: #ff9800;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,152,0,0.4); }
            70% { box-shadow: 0 0 0 20px rgba(255,152,0,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,152,0,0); }
        }

        /* Ph·∫ßn m·ªõi b·ªï sung */
        .output-section {
            margin-top: 15px;
            text-align: left;
        }
        .output-label {
            font-size: 10px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        #outputSelector {
            width: 100%;
            background: #252525;
            color: #ff9800;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 10px;
            font-size: 12px;
            outline: none;
            cursor: pointer;
        }

        #status {
            margin-top: 15px;
            font-size: 0.75rem;
            color: #ff9800;
        }
    </style>
</head>

<body>

<div class="card">
    <h1>Ti√™u Meow Live</h1>

    <div class="controls-row">
        <div class="circle-btn" id="liveBtn">LIVE</div>
        <div class="tiger-btn" id="tigerMascot">üêØ</div>
    </div>

    <div class="output-section">
        <div class="output-label">ƒê·∫ßu ra √¢m thanh:</div>
        <select id="outputSelector">
            <option value="">ƒêang qu√©t thi·∫øt b·ªã...</option>
        </select>
    </div>

    <div id="status">S·∫µn s√†ng</div>
</div>

<script>
const CONFIG = {
    gate: -45,
    pitch: 8,
    vibFreq: 4,
    vibDepth: 0.8,
    reverbWet: 0.15,
    micGain: 3.5 // TƒÉng gain nh·∫π ƒë·ªÉ mic nh·∫°y h∆°n
};

let isLive = false;
const mic = new Tone.UserMedia();
const micGain = new Tone.Gain(CONFIG.micGain);
let liveNodes = [];

// H√†m li·ªát k√™ c√°c loa/c√°p ·∫£o
async function updateOutputDevices() {
    try {
        // Bu·ªôc tr√¨nh duy·ªát h·ªèi quy·ªÅn Mic ƒë·ªÉ hi·ªán danh s√°ch thi·∫øt b·ªã
        await navigator.mediaDevices.getUserMedia({ audio: true });
        const devices = await navigator.mediaDevices.enumerateDevices();
        const selector = document.getElementById("outputSelector");
        selector.innerHTML = "";

        const outputs = devices.filter(device => device.kind === "audiooutput");
        
        outputs.forEach(device => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Loa ${selector.length + 1}`;
            selector.appendChild(option);
        });

        // T·ª± ƒë·ªông ch·ªçn CABLE Input n·∫øu t√¨m th·∫•y
        for (let i = 0; i < selector.options.length; i++) {
            if (selector.options[i].text.includes("CABLE Input")) {
                selector.selectedIndex = i;
                break;
            }
        }
    } catch (err) {
        document.getElementById("status").innerText = "L·ªói: H√£y c·∫•p quy·ªÅn Micro";
    }
}

// G·ªçi qu√©t thi·∫øt b·ªã khi web load
updateOutputDevices();

function createChain(destination) {
    const gate = new Tone.Gate(CONFIG.gate);
    const pitch = new Tone.PitchShift(CONFIG.pitch);
    const vibrato = new Tone.Vibrato(CONFIG.vibFreq, CONFIG.vibDepth);
    const chorus = new Tone.Chorus(4, 2.5, 0.5).start();
    const filter = new Tone.Filter(2200, "lowpass");
    const reverb = new Tone.Reverb({ decay: 1.5, wet: CONFIG.reverbWet });

    gate.chain(pitch, vibrato, chorus, filter, reverb, destination);
    return [gate, pitch, vibrato, chorus, filter, reverb];
}

document.getElementById("liveBtn").onclick = async function () {
    if (!isLive) {
        await Tone.start();
        try {
            const selector = document.getElementById("outputSelector");
            
            // THI·∫æT L·∫¨P ƒê·∫¶U RA: Tr·ªè √¢m thanh sang thi·∫øt b·ªã ƒë√£ ch·ªçn (CABLE Input)
            if (typeof Tone.getContext().rawContext.setSinkId === 'function') {
                await Tone.getContext().rawContext.setSinkId(selector.value);
            }

            await mic.open();
            isLive = true;
            this.classList.add("live-active");
            document.getElementById("tigerMascot").classList.add("playing");
            document.getElementById("status").innerText = "ƒêANG LIVE SANG C√ÅP ·∫¢O...";

            liveNodes = createChain(Tone.Destination);
            mic.connect(micGain);
            micGain.connect(liveNodes[0]);
        } catch (e) {
            console.error(e);
            alert("Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c Micro ho·∫∑c Thi·∫øt b·ªã ƒë·∫ßu ra");
        }
    } else {
        isLive = false;
        this.classList.remove("live-active");
        document.getElementById("tigerMascot").classList.remove("playing");
        document.getElementById("status").innerText = "ƒê√£ t·∫Øt Live";

        mic.close();
        micGain.disconnect();
        liveNodes.forEach(n => n.dispose());
        liveNodes = [];
    }
};

// PWA Service Worker
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
    });
}
</script>

</body>
</html>
