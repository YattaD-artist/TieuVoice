<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ti√™u Meow Live</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff9800">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body {
            margin: 0;
            background: #0f0f0f;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .card {
            background: #1a1a1a;
            padding: 2.5rem;
            border-radius: 40px;
            width: 320px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        h1 {
            color: #ff9800;
            font-size: 1.1rem;
            margin-bottom: 1.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .controls-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .tiger-btn {
            width: 100px;
            height: 100px;
            background: #252525;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            border: 4px solid #333;
            user-select: none;
        }
        .circle-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #ff9800;
            color: #ff9800;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
        }
        .live-active {
            background: #ff9800 !important;
            color: #000 !important;
            box-shadow: 0 0 20px rgba(255,152,0,0.6);
        }
        .playing {
            animation: pulse 1s infinite;
            border-color: #ff9800;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,152,0,0.4); }
            70% { box-shadow: 0 0 0 20px rgba(255,152,0,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,152,0,0); }
        }
        #status {
            font-size: 0.75rem;
            color: #ff9800;
        }
    </style>
</head>

<body>

<div class="card">
    <h1>Ti√™u Meow Live</h1>

    <div class="controls-row">
        <div class="circle-btn" id="liveBtn">LIVE</div>
        <div class="tiger-btn" id="tigerMascot">üêØ</div>
    </div>

    <div id="status">S·∫µn s√†ng</div>
</div>

<script>
/* ===== CONFIG T·ªêI ∆ØU M√îI TR∆Ø·ªúNG ·ªíN ===== */
const CONFIG = {
    micGain: 2.5,
    gate: -28,          // Gate m·∫°nh h∆°n
    highpass: 180,      // C·∫Øt ti·∫øng tr·∫ßm xa
    compThreshold: -24,
    compRatio: 4,
    pitch: 8,
    vibFreq: 4,
    vibDepth: 0.7,
    reverbWet: 0.1
};

let isLive = false;

const mic = new Tone.UserMedia();
const micGain = new Tone.Gain(CONFIG.micGain);
let liveNodes = [];

/* ===== CHAIN L·ªåC T·ªêI ∆ØU =====
HighPass ‚Üí Gate ‚Üí Compressor ‚Üí FX ‚Üí Output
*/
function createChain(destination) {
    const highpass = new Tone.Filter(CONFIG.highpass, "highpass");
    const gate = new Tone.Gate(CONFIG.gate);

    const compressor = new Tone.Compressor({
        threshold: CONFIG.compThreshold,
        ratio: CONFIG.compRatio,
        attack: 0.01,
        release: 0.2
    });

    const pitch = new Tone.PitchShift(CONFIG.pitch);
    const vibrato = new Tone.Vibrato(CONFIG.vibFreq, CONFIG.vibDepth);
    const chorus = new Tone.Chorus(4, 2.5, 0.5).start();
    const lowpass = new Tone.Filter(2200, "lowpass");
    const reverb = new Tone.Reverb({ decay: 1.5, wet: CONFIG.reverbWet });

    highpass.chain(
        gate,
        compressor,
        pitch,
        vibrato,
        chorus,
        lowpass,
        reverb,
        destination
    );

    return [highpass, gate, compressor, pitch, vibrato, chorus, lowpass, reverb];
}

document.getElementById("liveBtn").onclick = async function () {
    if (!isLive) {
        await Tone.start();
        try {
            await mic.open();
            isLive = true;

            this.classList.add("live-active");
            document.getElementById("tigerMascot").classList.add("playing");
            document.getElementById("status").innerText = "ƒêANG LIVE...";

            liveNodes = createChain(Tone.Destination);
            mic.connect(micGain);
            micGain.connect(liveNodes[0]);
        } catch {
            alert("Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c Micro");
        }
    } else {
        isLive = false;

        this.classList.remove("live-active");
        document.getElementById("tigerMascot").classList.remove("playing");
        document.getElementById("status").innerText = "ƒê√£ t·∫Øt Live";

        mic.close();
        micGain.disconnect();
        liveNodes.forEach(n => n.dispose());
        liveNodes = [];
    }
};

/* Service Worker */
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
    });
}
</script>

</body>
</html>
